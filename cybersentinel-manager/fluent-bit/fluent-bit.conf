# Fluent Bit Configuration for CyberSentinel
# Forwards Wazuh alerts to Graylog RAW TCP Input

# ============================================
# Service Configuration
# ============================================
[SERVICE]
    # Flush interval in seconds
    Flush           5
    # Logging level (error, warning, info, debug, trace)
    Log_Level       info
    # Daemon mode (off for Docker)
    Daemon          off
    # HTTP monitoring server
    HTTP_Server     On
    HTTP_Listen     0.0.0.0
    HTTP_Port       2020
    # Filesystem buffering for reliability
    storage.path              /tmp/fluent-bit-storage/
    storage.sync              normal
    storage.checksum          off
    storage.max_chunks_up     128
    storage.backlog.mem_limit 5M

# ============================================
# INPUT: Wazuh Alerts (JSON Format)
# ============================================
[INPUT]
    Name                tail
    Path                /var/ossec/logs/alerts/alerts.json
    Parser              json
    Tag                 wazuh
    Refresh_Interval    5
    Mem_Buf_Limit       10MB
    Skip_Empty_Lines    On
    Skip_Long_Lines     On
    DB                  /tmp/fluent-bit-storage/wazuh-alerts.db
    Read_from_Head      False
    # Enable filesystem buffering
    storage.type        filesystem

# ============================================
# FILTER: Add CyberSentinel Metadata
# ============================================
[FILTER]
    Name         modify
    Match        wazuh
    Add          source CyberSentinel
    Add          environment production
    Add          siem_platform cybersentinel
    Add          log_type CyberSentinel_alert

# ============================================
# OUTPUT: Graylog RAW TCP Input (Port 5555)
# ============================================
[OUTPUT]
    Name          tcp
    Match         wazuh
    Host          graylog
    Port          5555
    Format        json_lines
    # Retry configuration
    Retry_Limit   5
    # Use filesystem storage for buffering
    storage.total_limit_size 10M

# ============================================
# OUTPUT: Stdout (for debugging - optional)
# ============================================
[OUTPUT]
    Name          stdout
    Match         wazuh
    Format        json_lines

# ============================================
# CONFIGURATION NOTES
# ============================================
# This configuration:
# 1. Reads Wazuh alerts from /var/ossec/logs/alerts/alerts.json
# 2. Parses JSON automatically
# 3. Tags all logs as "wazuh"
# 4. Adds CyberSentinel metadata fields
# 5. Forwards to Graylog RAW TCP input on port 5555
# 6. Uses filesystem buffering for reliability
# 7. Outputs json_lines format (one JSON object per line)
#
# Graylog Setup Required:
# 1. System -> Inputs -> Launch new input
# 2. Select "Raw/Plaintext TCP"
# 3. Port: 5555
# 4. Bind address: 0.0.0.0
# 5. Check "Store full message"
# 6. Save
#
# To test connectivity:
# docker exec -it fluent-bit nc -zv graylog 5555
